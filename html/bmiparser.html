
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>bmiparser</title><meta name="generator" content="MATLAB 9.8"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2021-08-25"><meta name="DC.source" content="bmiparser.m"><style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; }

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }
span.typesection { color:#A0522D }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><div class="content"><h2>Contents</h2><div><ul><li><a href="#3">&#23383;&#21477;&#35299;&#26512;&#12398;&#21069;&#20966;&#29702;</a></li><li><a href="#4">&#23383;&#21477;&#35299;&#26512;</a></li><li><a href="#5">&#34892;&#21015;(matrixlist)&#12398;&#32080;&#21512;</a></li><li><a href="#6">he&#12398;&#20998;&#38626;</a></li><li><a href="#7">&#21452;&#32218;&#24418;&#38917;&#12398;&#20998;&#38626;</a></li><li><a href="#8">BMI&#19968;&#33324;&#21270;&#65292;Q,L,N,R&#12398;&#21462;&#24471;</a></li><li><a href="#9">&#36880;&#27425;LMI&#12395;&#22793;&#24418;&#12375;&#12390;Calc</a></li><li><a href="#10">&#12487;&#12496;&#12483;&#12464;&#29992;&#20986;&#21147;, &#19968;&#33324;&#21270;BMI&#12398;&#24773;&#22577;</a></li><li><a href="#11">&#38306;&#25968;&#12398;&#20986;&#21147;</a></li><li><a href="#13">&#20869;&#37096;&#38306;&#25968;&#32676;</a></li><li><a href="#14">List&#12398;&#26356;&#26032;&#65288;&#36861;&#21152;&#65289;&#12392;&#21021;&#26399;&#21270;</a></li><li><a href="#15">&#25324;&#24359;()&#12434;&#23637;&#38283;&#12377;&#12427;&#38306;&#25968;</a></li><li><a href="#17">&#27491;&#35215;&#34920;&#29694;&#29992;&#12510;&#12472;&#12483;&#12463;&#12490;&#12531;&#12496;&#12540;&#65292;&#27491;&#35215;&#34920;&#29694;&#12434;&#35201;&#32032;&#12372;&#12392;&#12395;&#20998;&#35299;</a></li><li><a href="#18">&#21508;&#12497;&#12479;&#12540;&#12531;&#12395;&#12362;&#12369;&#12427;&#25324;&#24359;()&#12398;&#20966;&#29702;</a></li></ul></div><pre class="codeinput"><span class="keyword">function</span> [LMI,BMI,gBMI] = bmiparser(S, vlist, v0list, G)
</pre><pre class="codeinput"><span class="comment">% BMI&#12398;&#25991;&#23383;&#21015;&#12434;&#21463;&#12369;&#21462;&#12426;&#65292;&#36880;&#27425;LMI&#12398;&#20516;&#12434;&#36820;&#12377;&#12497;&#12540;&#12469;&#12540;</span>
<span class="comment">%</span>
<span class="comment">%   OUTPUT:</span>
<span class="comment">%       LMI: &#36880;&#27425;LMI(&#22793;&#25563;&#24460;)&#12398;&#20516;</span>
<span class="comment">%       BMI: BMI(&#22793;&#25563;&#21069;)&#12398;&#20516;</span>
<span class="comment">%       gBMI: &#19968;&#33324;&#21270;BMI(He(Q+LXNYR))&#12398;&#34892;&#21015;&#12398;&#24773;&#22577;(&#27083;&#36896;&#20307;)</span>
<span class="comment">%</span>
<span class="comment">%   INPUT:</span>
<span class="comment">%       S: BMI&#12398;&#25991;&#23383;&#21015;</span>
<span class="comment">%           ex) "P*A+P*B*K*C+A'*P'+C'*K'*B'*P'"</span>
<span class="comment">%       vlist: &#27770;&#23450;&#22793;&#25968;&#12398;&#25991;&#23383;&#21015;</span>
<span class="comment">%           ex) {'P','K'}</span>
<span class="comment">%       v0list: &#26283;&#23450;&#35299;&#12398;&#25991;&#23383;&#21015;</span>
<span class="comment">%           ex) {'P0','K0'}</span>
<span class="comment">%       G: gamma&#12398;&#23450;&#25968;&#20493;&#65292;&#12487;&#12501;&#12457;&#12523;&#12488;&#12391;&#21336;&#20301;&#34892;&#21015;</span>
<span class="comment">%</span>
<span class="comment">%</span>
<span class="comment">%   &#8251;&#12527;&#12540;&#12463;&#12473;&#12506;&#12540;&#12473;&#12398;&#22793;&#25968;&#12398;&#20516;&#12434;&#21033;&#29992;&#12375;&#12390;&#35336;&#31639;&#12377;&#12427;&#12398;&#12391;&#65292;</span>
<span class="comment">%     bmiparser&#38306;&#25968;&#12434;&#21628;&#12403;&#20986;&#12377;&#21069;&#12395;&#65292;</span>
<span class="comment">%     &#12354;&#12425;&#12363;&#12376;&#12417;&#12395;&#22793;&#25968;&#12434;&#23459;&#35328;&#12377;&#12427;&#24517;&#35201;&#12364;&#12354;&#12427;&#65294;</span>
<span class="comment">%       ex)</span>
<span class="comment">%           X = sdpvar(2,2)</span>
<span class="comment">%           Y = sdpvar(3,2)</span>
<span class="comment">%           A = rand(2,3)</span>
<span class="comment">%           X0= rand(2,2)</span>
<span class="comment">%           Y0= rand(3,2)</span>
<span class="comment">%           LMI = bmiparser("X*A*Y+(X*A*Y)'",{'X','Y'},{'X0','Y0'})</span>
<span class="comment">%</span>
<span class="comment">%</span>
<span class="comment">%   &#29694;&#27573;&#38542;&#65306;</span>
<span class="comment">%       &#12539;()&#12434;&#20351;&#12387;&#12383;&#20998;&#37197;&#27861;&#21063;&#12420;&#36578;&#32622;&#12364;&#21487;&#33021;, ()&#12398;&#20837;&#12428;&#23376;&#12399;&#23550;&#24540;&#12391;&#12365;&#12390;&#12356;&#12394;&#12356;</span>
<span class="comment">%       &#12539;&#25968;&#20516;&#12434;&#30452;&#25509;&#35352;&#36848;&#12375;&#12383;&#22580;&#21512;&#12398;&#12473;&#12459;&#12521;&#12540;&#20493;&#12395;&#12414;&#12384;&#23550;&#24540;&#12391;&#12365;&#12390;&#12356;&#12394;&#12356;, &#22793;&#25968;&#21517;&#12399;&#21487;&#33021;</span>
<span class="comment">%       &#12539;&#34892;&#21015;[]&#12398;&#21644;&#12395;&#12424;&#12427;&#35352;&#36848;&#12364;&#21487;&#33021;</span>
<span class="comment">%       &#12539;[]&#12398;&#20837;&#12428;&#23376;&#12395;&#12414;&#12384;&#23550;&#24540;&#12391;&#12365;&#12390;&#12356;&#12394;&#12356;</span>
<span class="comment">%</span>

<span class="comment">% &#25991;&#23383;&#21015;&#12434;&#25991;&#23383;&#12505;&#12463;&#12488;&#12523;&#12395;&#22793;&#25563;</span>
<span class="keyword">if</span> isa(S,<span class="string">'string'</span>)
    S = char(S);
<span class="keyword">end</span>
<span class="comment">% str2sym(S)</span>

<span class="comment">% &#38306;&#25968;&#24341;&#25968;&#12398;&#21462;&#24471;</span>
Xstr =vlist{1};
Ystr =vlist{2};
X0str=v0list{1};
Y0str=v0list{2};
</pre><pre class="codeoutput error">&#20837;&#21147;&#24341;&#25968;&#12364;&#19981;&#36275;&#12375;&#12390;&#12356;&#12414;&#12377;&#12290;

&#12456;&#12521;&#12540;: bmiparser (line 39)
if isa(S,'string')
</pre><h2 id="3">&#23383;&#21477;&#35299;&#26512;&#12398;&#21069;&#20966;&#29702;</h2><pre class="codeinput"><span class="comment">% &#31354;&#25991;&#23383;&#12434;&#21066;&#28187;</span>
S = regexprep(S,<span class="string">'(\s+)'</span>,<span class="string">' '</span>)

<span class="comment">% &#25324;&#24359;&#12398;&#20966;&#29702;</span>
<span class="comment">% eye(2,2)&#12398;&#12424;&#12358;&#12395;&#65292;&#38306;&#25968;&#12398;&#25324;&#24359;&#12399;&#20966;&#29702;&#12375;&#12394;&#12356;</span>
<span class="keyword">while</span> regexp(S,<span class="string">'(?&lt;!\w+)\((.*)\)'</span>)
    <span class="comment">% &#25324;&#24359;()&#12434;&#23637;&#38283;&#12377;&#12427;</span>
    S = divbracket(S);
<span class="keyword">end</span>
<span class="comment">% S</span>

<span class="comment">% &#36578;&#32622;'&#12398;&#20966;&#29702;</span>
<span class="comment">% &#22855;&#25968;&#20491;:1&#12467; &#12395;&#22793;&#25563;</span>
S = regexprep(S,<span class="string">"\'(\'\')*"</span>,<span class="string">"\'"</span>);
<span class="comment">% &#20598;&#25968;&#20491;:0&#12467; &#12395;&#22793;&#25563;</span>
S = regexprep(S,<span class="string">"(\'\')+"</span>,<span class="string">""</span>);
<span class="comment">%</span>
S
</pre><h2 id="4">&#23383;&#21477;&#35299;&#26512;</h2><p>ex) "P*A+P*B*K*C" =&gt;  {{"P","B"},{"P","B","K","C"}} ex) "P'*A'" =&gt;  {{"P'","A'"}}</p><pre class="codeinput">termlist = {}; <span class="comment">% &#38917;&#12398;&#12522;&#12473;&#12488;</span>
varlist = {};  <span class="comment">% &#22793;&#25968;&#23450;&#25968;&#12398;&#37197;&#21015;(&#19968;&#26178;&#30340;)</span>
varstr = <span class="string">""</span>;   <span class="comment">% 1&#12388;&#12398;&#22793;&#25968;&#12398;&#25991;&#23383;&#21015;(&#19968;&#26178;&#30340;)</span>

<span class="comment">% &#21046;&#32004;&#12364;&#34892;&#21015;&#12398;&#22580;&#21512;</span>
columlist = {}; <span class="comment">% &#34892;&#12398;&#12522;&#12473;&#12488;&#65292;termlist&#12434;&#12371;&#12398;&#20013;&#12395;&#20837;&#12428;&#12427;</span>
colnum = 1;     <span class="comment">% &#34892;&#25968;</span>
rownum = 1;     <span class="comment">% &#21015;&#25968;</span>

<span class="comment">% &#35079;&#25968;&#34892;&#21015;&#12398;&#21644;&#12395;&#23550;&#24540;</span>
matrixlist = {}; <span class="comment">% &#34892;&#21015;[...]&#12398;&#23383;&#21477;&#35299;&#26512;&#32080;&#26524;(smatrix)&#12434;&#26684;&#32013;&#12377;&#12427;, &#26368;&#32066;&#30340;&#12395;1&#12388;&#12398;smatrix&#12395;&#12377;&#12427;</span>

<span class="comment">% &#12487;&#12496;&#12483;&#12464;&#29992;:</span>
<span class="comment">% disp("==========")</span>
<span class="comment">% &#20837;&#21147;&#25991;&#23383;&#21015;&#12434;1&#25991;&#23383;&#12378;&#12388;&#35299;&#26512;</span>
<span class="keyword">for</span> i=1:strlength(S)
    <span class="comment">% &#12487;&#12496;&#12483;&#12464;&#29992;:</span>
    <span class="comment">% disp("-----")</span>
    <span class="comment">% S(i),varstr,varlist,termlist</span>


    <span class="comment">% &#22793;&#25968;&#12398;&#25991;&#23383;&#21015;&#12398;&#22580;&#21512;</span>
    <span class="comment">% ex) 'var' = 'v'+'a'+'r'</span>
    <span class="comment">% &#27491;&#35215;&#34920;&#29694;[a-zA-Z_0-9], (), '</span>
    <span class="comment">% ex) a0&#12399;&#22793;&#25968;&#12384;&#12364;&#65292;0a&#12399;&#22793;&#25968;&#12391;&#12394;&#12356; -&gt; &#12393;&#12358;&#20966;&#29702;&#12377;&#12427;&#65311;</span>
    <span class="keyword">if</span> regexp(S(i), <span class="string">"[\w\(\,\)\']"</span>)
        <span class="comment">% &#12393;&#12371;&#12414;&#12391;&#12364;&#22793;&#25968;&#21517;&#12363;&#12434;&#25512;&#23450;&#12377;&#12427;</span>
        <span class="comment">% &#22793;&#25968;&#21517;&#12398;&#26356;&#26032;</span>
        varstr = varstr + S(i);
        <span class="keyword">if</span> i == strlength(S)
            <span class="comment">% &#32066;&#31471;&#25991;&#23383;&#12398;&#22580;&#21512;&#65292;varlist&#12434;termlist&#12395;&#36861;&#21152;</span>
            <span class="comment">% "A]"&#12392;&#12363;&#12384;&#12392;&#21029;&#20966;&#29702;&#12364;&#24517;&#35201;&#65292;"[...]"&#12398;&#20966;&#29702;</span>
            [varlist, varstr] = updateList(varlist,varstr);
            [termlist, varlist] = updateList(termlist,varlist,1);
            [columlist, termlist] = updateList(columlist,termlist);
            <span class="comment">%</span>
            <span class="comment">% smatrix&#12434;matrixlist&#12395;&#36861;&#21152;</span>
            <span class="keyword">if</span> colnum &gt; 1 || rownum &gt; 1
                <span class="comment">% &#12502;&#12525;&#12483;&#12463;&#34892;&#21015;&#12398;&#22580;&#21512;</span>
                smatrix = reshape(columlist,colnum,rownum).';
            <span class="keyword">else</span>
                <span class="comment">% &#12381;&#12358;&#12391;&#12394;&#12356;&#22580;&#21512;</span>
                smatrix = columlist;
            <span class="keyword">end</span>
            [matrixlist,smatrix] = updateList(matrixlist,smatrix);
        <span class="keyword">end</span>
        <span class="keyword">continue</span>
    <span class="keyword">end</span>

    <span class="comment">% &#28436;&#31639;&#23376;&#12398;&#22580;&#21512;</span>
    <span class="comment">% &#21644;+</span>
    <span class="keyword">if</span> regexp(S(i), <span class="string">'\+'</span>)
        <span class="comment">% varstr&#12434;varlist&#12395;&#36861;&#21152;, varstr&#21021;&#26399;&#21270;</span>
        [varlist, varstr] = updateList(varlist,varstr);
        <span class="comment">% varlist&#12434;termlist&#12395;&#36861;&#21152;&#65292;varlist&#21021;&#26399;&#21270;</span>
        [termlist, varlist] = updateList(termlist,varlist,1);
        <span class="keyword">continue</span>
    <span class="keyword">end</span>
    <span class="comment">% &#31309;*</span>
    <span class="keyword">if</span> regexp(S(i), <span class="string">'\*'</span>)
        [varlist, varstr] = updateList(varlist,varstr);
        <span class="keyword">continue</span>
    <span class="keyword">end</span>

    <span class="comment">% &#24046;-</span>
    <span class="comment">% ex) "-A*B": {"-","A","B"}</span>
    <span class="keyword">if</span> regexp(S(i), <span class="string">'\-'</span>)
        <span class="comment">% &#21069;&#12414;&#12391;&#12398;&#38917;&#12434;&#12522;&#12473;&#12488;&#36861;&#21152;(&#12354;&#12428;&#12400;)</span>
        <span class="keyword">if</span> varstr ~= <span class="string">""</span>
            [varlist, varstr] = updateList(varlist,varstr);
            [termlist, varlist] = updateList(termlist,varlist,1);
        <span class="keyword">end</span>
        <span class="comment">% &#26032;&#12375;&#12356;&#38917;&#12398;1&#25991;&#23383;&#30446;&#12395;&#20837;&#12428;&#12427;</span>
        varstr = varstr + S(i);
        [varlist, varstr] = updateList(varlist,varstr);
        <span class="keyword">continue</span>
    <span class="keyword">end</span>

    <span class="comment">% &#12471;&#12531;&#12464;&#12523;&#12463;&#12458;&#12540;&#12486;&#12540;&#12471;&#12519;&#12531;&#12398;&#22580;&#21512;</span>
    <span class="comment">% ex) A'*B'&#65306;&#34892;&#21015;&#12398;&#36578;&#32622;&#12434;&#12377;&#12427;&#26178;&#12395;&#20351;&#12358;</span>
    <span class="comment">% &#29694;&#29366; \w &#12392;&#21516;&#12376;&#20966;&#29702;</span>
<span class="comment">%     if regexp(S(i), "\'")</span>
<span class="comment">%         varstr = varstr + S(i);</span>
<span class="comment">%         if i == strlength(S)</span>
<span class="comment">%             % &#32066;&#31471;&#25991;&#23383;&#12398;&#22580;&#21512;&#65292;termstr&#12434;termlist&#12395;&#36861;&#21152;</span>
<span class="comment">%             [varlist, varstr] = updateList(varlist,varstr);</span>
<span class="comment">%             [termlist, varlist] = updateList(termlist,varlist,1);</span>
<span class="comment">%             [columlist, termlist] = updateList(columlist,termlist);</span>
<span class="comment">%         end</span>
<span class="comment">%         continue</span>
<span class="comment">%     end</span>

    <span class="comment">% &#31354;&#25991;&#23383;&#12398;&#22580;&#21512;</span>
    <span class="comment">% ex) '[A B]' : &#34892;&#21015;&#12398;&#21015;&#12434;&#29983;&#25104;&#12377;&#12427;&#12392;&#12365;&#12395;&#20351;&#12358;</span>
    <span class="keyword">if</span> regexp(S(i), <span class="string">'\s'</span>)
        <span class="keyword">if</span> ~isempty(regexp(S(i-1), <span class="string">'\s'</span>, <span class="string">'once'</span>)) ||<span class="keyword">...</span>
           ~isempty(regexp(S(i), <span class="string">'[\*\+]'</span>, <span class="string">'once'</span>))
            <span class="keyword">continue</span>
        <span class="keyword">elseif</span> regexp(S(i-1), <span class="string">"[\w\'\)]"</span>)
            [varlist, varstr] = updateList(varlist,varstr);
            [termlist, varlist] = updateList(termlist,varlist,1);
            [columlist, termlist] = updateList(columlist,termlist);
            <span class="comment">% &#21015;&#25968;&#12398;&#26356;&#26032;</span>
            rownum = rownum + 1;
            <span class="keyword">continue</span>
        <span class="keyword">end</span>
    <span class="keyword">end</span>
    <span class="comment">% &#12475;&#12511;&#12467;&#12525;&#12531;;&#12398;&#22580;&#21512;</span>
    <span class="comment">% ex) '[A;B]' : &#34892;&#21015;&#12398;&#34892;&#12434;&#29983;&#25104;&#12377;&#12427;&#12392;&#12365;&#12395;&#20351;&#12358;</span>
    <span class="keyword">if</span> regexp(S(i), <span class="string">';'</span>)
        [varlist, varstr] = updateList(varlist,varstr);
        [termlist, varlist] = updateList(termlist,varlist,1);
        [columlist, termlist] = updateList(columlist,termlist);
        <span class="comment">% &#34892;&#25968;&#26356;&#26032;</span>
        colnum = colnum + 1;
        rownum = 1;
        <span class="keyword">continue</span>
    <span class="keyword">end</span>

    <span class="comment">% [&#12398;&#22580;&#21512;</span>
    <span class="comment">% &#21046;&#32004;&#12399;&#34892;&#21015;</span>
    <span class="keyword">if</span> regexp(S(i), <span class="string">'\['</span>)
        <span class="comment">% disp("Helo")</span>
        <span class="comment">% &#34892;&#21015;&#12434;&#35299;&#26512;&#12377;&#12427;&#12383;&#12417;&#12398;&#21021;&#26399;&#21270;</span>
        termlist = {}; <span class="comment">% &#38917;&#12398;&#12522;&#12473;&#12488;</span>
        varlist = {};  <span class="comment">% &#22793;&#25968;&#23450;&#25968;&#12398;&#37197;&#21015;(&#19968;&#26178;&#30340;)</span>
        varstr = <span class="string">""</span>;   <span class="comment">% 1&#12388;&#12398;&#22793;&#25968;&#12398;&#25991;&#23383;&#21015;(&#19968;&#26178;&#30340;)</span>
        columlist = {}; <span class="comment">% &#34892;&#12398;&#12522;&#12473;&#12488;</span>
        colnum = 1;     <span class="comment">% &#34892;&#25968;</span>
        rownum = 1;     <span class="comment">% &#21015;&#25968;</span>
        <span class="keyword">continue</span>
    <span class="keyword">end</span>
    <span class="comment">% ]&#12398;&#22580;&#21512;</span>
    <span class="comment">% &#34892;&#21015;&#12362;&#12431;&#12426;</span>
    <span class="keyword">if</span> regexp(S(i), <span class="string">'\]'</span>)
        <span class="comment">% disp("bye")</span>
        [varlist, varstr] = updateList(varlist,varstr);
        [termlist, varlist] = updateList(termlist,varlist,1);
        [columlist, termlist] = updateList(columlist,termlist);
        <span class="comment">%</span>
        <span class="comment">% smatrix&#12398;&#29983;&#25104;</span>
        <span class="comment">% S&#12398;&#26368;&#32066;&#24418;&#24907;(cell&#12398;&#34892;&#21015;), columlist&#12434;&#32294;&#12395;&#20006;&#12409;&#12383;&#12418;&#12398;</span>
        <span class="keyword">if</span> colnum &gt; 1 || rownum &gt; 1
            <span class="comment">% &#12502;&#12525;&#12483;&#12463;&#34892;&#21015;&#12398;&#22580;&#21512;</span>
            smatrix = reshape(columlist,colnum,rownum).';
        <span class="keyword">else</span>
            <span class="comment">% &#12381;&#12358;&#12391;&#12394;&#12356;&#22580;&#21512;</span>
            smatrix = columlist;
        <span class="keyword">end</span>
        <span class="comment">% smatrix&#12434;matrixlist&#12395;&#36861;&#21152;</span>
        [matrixlist,smatrix] = updateList(matrixlist,smatrix);
        <span class="keyword">continue</span>
    <span class="keyword">end</span>

<span class="keyword">end</span>
<span class="comment">% &#12487;&#12496;&#12483;&#12464;</span>
<span class="comment">% columlist</span>
<span class="comment">% columlist{1,5}{1,1}</span>
<span class="comment">% colnum, rownum</span>
<span class="comment">% smatrix = cat(2,cat(2,smatrix{1,1},smatrix{2,1}),smatrix{3,1});</span>
<span class="comment">% smatrix = reshape(smatrix,[colnum,rownum])</span>

<span class="comment">% smatrix&#12398;&#29983;&#25104;</span>
<span class="comment">% S&#12398;&#26368;&#32066;&#24418;&#24907;(cell&#12398;&#34892;&#21015;), columlist&#12434;&#32294;&#12395;&#20006;&#12409;&#12383;&#12418;&#12398;</span>
<span class="comment">% if colnum &gt; 1 || rownum &gt; 1</span>
<span class="comment">%     % &#12502;&#12525;&#12483;&#12463;&#34892;&#21015;&#12398;&#22580;&#21512;</span>
<span class="comment">%     smatrix = reshape(columlist,colnum,rownum).';</span>
<span class="comment">% else</span>
<span class="comment">%     % &#12381;&#12358;&#12391;&#12394;&#12356;&#22580;&#21512;</span>
<span class="comment">%     smatrix = columlist;</span>
<span class="comment">% end</span>
<span class="comment">% cat(2,matrixlist,smatrix)</span>
<span class="comment">% cat(2,matrixlist,{smatrix})</span>
<span class="comment">% matrixlist</span>
<span class="comment">% matrixlist{1,1}</span>
<span class="comment">% matrixlist{1,1}{1,1}</span>
<span class="comment">% matrixlist{1,1}{1,1}{1,1}</span>
<span class="comment">% matrixlist{1,1}{1,1}{1,1}{1,1}</span>
</pre><h2 id="5">&#34892;&#21015;(matrixlist)&#12398;&#32080;&#21512;</h2><pre class="codeinput"><span class="keyword">for</span> i=1:length(matrixlist)
    mat = matrixlist{1,i};
    <span class="keyword">if</span> i == 1
        smatrix = mat;
        <span class="keyword">continue</span>
    <span class="keyword">end</span>
    <span class="comment">% &#21508;smatrix&#12398;&#38917;&#12434;&#32080;&#21512;&#12377;&#12427;</span>
    <span class="keyword">for</span> col=1:size(mat,1)
        <span class="keyword">for</span> row=1:size(mat,2)
            smatrix{col,row} = cat(1,smatrix{col,row},mat{col,row});
        <span class="keyword">end</span>
    <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="comment">% &#12487;&#12496;&#12483;&#12464;&#29992;:</span>
<span class="comment">% smatrix</span>
<span class="comment">% smatrix{1,1}</span>
<span class="comment">% smatrix{1,1}{1,1}</span>
<span class="comment">% smatrix{1,1}{1,1}{1,1}</span>
<span class="comment">% smatrix{2,1}{1,2}</span>
<span class="comment">% smatrix{2,1}{1,2}{1,1}</span>
<span class="comment">% smatrix{2,1}{1,2}{1,2}</span>
<span class="comment">% smatrix{3,1}{1,3}{1,2}</span>

<span class="comment">% smatrix(1,2)</span>
<span class="comment">% smatrix{1,2}</span>
<span class="comment">% columlist{1,3}{2,1}</span>
<span class="comment">% smatrix{1,3}{2,1}</span>
</pre><h2 id="6">he&#12398;&#20998;&#38626;</h2><pre class="codeinput">orgmatrix = smatrix; <span class="comment">% &#36578;&#32622;&#12394;&#12375;&#34892;&#21015;</span>
hematrix = smatrix;  <span class="comment">% &#36578;&#32622;&#12354;&#12426;&#34892;&#21015;</span>

orgtermlist = {};    <span class="comment">% &#38917;&#12398;&#12522;&#12473;&#12488;(&#21021;&#26399;&#21270;)</span>
hetermlist = {};     <span class="comment">% &#38917;&#12398;&#36578;&#32622;&#12354;&#12426;&#12522;&#12473;&#12488;(&#21021;&#26399;&#21270;)</span>

<span class="keyword">for</span> col=1:size(smatrix,1)
    <span class="comment">% &#21508;&#34892;&#12505;&#12463;&#12488;&#12523;</span>
    <span class="keyword">for</span> row=1:size(smatrix,2)
        <span class="comment">% &#21508;&#34892;&#21015;&#35201;&#32032;</span>
        <span class="comment">% disp(col+" "+row)</span>
        termlist = smatrix{col,row};
        <span class="keyword">for</span> i=1:size(termlist,1)
            <span class="comment">% &#35201;&#32032;&#12398;&#21508;&#38917;</span>
            term = termlist{i,1};
            <span class="keyword">for</span> j=1:size(term,2)
                <span class="comment">% &#38917;&#12398;&#12381;&#12428;&#12382;&#12428;&#12398;&#22793;&#25968;</span>
                var = term{1,j};
                <span class="keyword">if</span> regexp(var, <span class="string">"\'"</span>)
                    <span class="comment">% var</span>
                    <span class="comment">% hetermlist: &#36578;&#32622;&#12354;&#12426;</span>
                    hetermlist = updateList(hetermlist,term,1);
                    <span class="keyword">break</span>
                <span class="keyword">else</span>
                    <span class="comment">% termlist: &#36578;&#32622;&#12394;&#12375;</span>
                    <span class="comment">% if col == row &amp;&amp; col &gt;= 2</span>
                    <span class="comment">%     % (2,2),(3,3)&#35201;&#32032;&#12399;1/2&#20493;&#12377;&#12427;</span>
                    <span class="comment">%     % &#12473;&#12459;&#12521;&#12540;&#20493;&#12434;&#23455;&#35013;&#12375;&#12394;&#12356;&#12392;&#12391;&#12365;&#12394;&#12356;</span>
                    <span class="comment">% end</span>
                    orgtermlist = updateList(orgtermlist,term,1);
                    <span class="keyword">break</span>
                <span class="keyword">end</span>
            <span class="keyword">end</span>
        <span class="keyword">end</span>
        <span class="comment">% &#36578;&#32622;&#12394;&#12375;&#34892;&#21015;&#12398;&#26356;&#26032;</span>
        orgmatrix(col,row) = {orgtermlist};
        orgtermlist = {};
        <span class="comment">% &#36578;&#32622;&#12354;&#12426;&#34892;&#21015;&#12398;&#26356;&#26032;</span>
        hematrix(col,row) = {hetermlist};
        hetermlist = {};
    <span class="keyword">end</span>
<span class="keyword">end</span>
<span class="comment">% '&#12364;&#12354;&#12387;&#12383;&#12425;&#65292;hematrix&#12395;&#36861;&#21152;</span>
<span class="comment">% &#12487;&#12496;&#12483;&#12464;&#29992;:</span>
<span class="comment">% orgmatrix</span>
<span class="comment">% hematrix</span>
</pre><h2 id="7">&#21452;&#32218;&#24418;&#38917;&#12398;&#20998;&#38626;</h2><p>&#34892;&#21015;</p><pre class="codeinput">linearmatrix = orgmatrix; <span class="comment">% &#23450;&#25968;&#38917;&#65292;1&#27425;&#38917;</span>
binearmatrix = orgmatrix; <span class="comment">% &#21452;&#32218;&#24418;&#38917;</span>

<span class="comment">% &#19968;&#26178;&#30340;&#12522;&#12473;&#12488;</span>
linearlist = {}; <span class="comment">% &#23450;&#25968;&#38917;&#65292;1&#27425;&#38917;</span>
binearlist = {}; <span class="comment">% &#21452;&#32218;&#24418;&#38917;</span>


<span class="keyword">for</span> col=1:size(orgmatrix,1)
    <span class="comment">% &#21508;&#34892;&#12505;&#12463;&#12488;&#12523;</span>
    <span class="keyword">for</span> row=1:size(orgmatrix,2)
        <span class="comment">% &#21508;&#34892;&#21015;&#35201;&#32032;</span>
        <span class="comment">% disp(col+" "+row)</span>
        termlist = orgmatrix{col,row};
        <span class="keyword">for</span> i=1:size(termlist,1)
            <span class="comment">% &#35201;&#32032;&#12398;&#21508;&#38917;</span>
            term = termlist{i,1};
            <span class="comment">%</span>
            varcount = 0; <span class="comment">% &#27770;&#23450;&#22793;&#25968;&#12398;&#25968;</span>
            <span class="keyword">for</span> j=1:size(term,2)
                <span class="comment">% &#38917;&#12398;&#12381;&#12428;&#12382;&#12428;&#12398;&#22793;&#25968;</span>
                var = term{1,j};
                <span class="keyword">if</span> ~isempty(regexp(var, Xstr, <span class="string">'once'</span>)) ||<span class="keyword">...</span>
                   ~isempty(regexp(var, Ystr, <span class="string">'once'</span>))
                    varcount = varcount + 1;
                <span class="keyword">end</span>
                <span class="keyword">if</span> varcount &gt;= 2
                    binearlist = updateList(binearlist,term,1);
                    <span class="keyword">break</span>
                <span class="keyword">elseif</span> j == size(term,2)
                    linearlist = updateList(linearlist,term,1);
                    <span class="keyword">break</span>
                <span class="keyword">end</span>
            <span class="keyword">end</span>
        <span class="keyword">end</span>
        <span class="comment">% &#32218;&#24418;&#38917;&#12398;&#34892;&#21015;</span>
        linearmatrix(col,row) = {linearlist};
        linearlist = {};
        <span class="comment">% &#21452;&#32218;&#24418;&#38917;&#12398;&#34892;&#21015;</span>
        binearmatrix(col,row) = {binearlist};
        binearlist = {};
    <span class="keyword">end</span>
<span class="keyword">end</span>
<span class="comment">% &#12487;&#12496;&#12483;&#12464;&#29992;:</span>
<span class="comment">% linearmatrix</span>
<span class="comment">% binearmatrix</span>

<span class="comment">% binearmatrix{1,1}{1,1}</span>
<span class="comment">% binearmatrix{1,2}{1,1}</span>
</pre><h2 id="8">BMI&#19968;&#33324;&#21270;&#65292;Q,L,N,R&#12398;&#21462;&#24471;</h2><pre class="codeinput">Q = linearmatrix; <span class="comment">% &#23450;&#25968;&#38917;&#65292;&#19968;&#27425;&#38917;</span>
L = {}; <span class="comment">% &#21452;&#32218;&#24418;&#38917;&#12398;&#23450;&#25968;&#34892;&#21015;(&#24038;)</span>
N = {}; <span class="comment">% &#21452;&#32218;&#24418;&#38917;&#12398;&#23450;&#25968;&#34892;&#21015;(&#20013;)</span>
R = {}; <span class="comment">% &#21452;&#32218;&#24418;&#38917;&#12398;&#23450;&#25968;&#34892;&#21015;(&#21491;)</span>


<span class="keyword">for</span> col=1:size(binearmatrix,1)
    <span class="comment">% &#21508;&#34892;&#12505;&#12463;&#12488;&#12523;</span>
    <span class="keyword">for</span> row=1:size(binearmatrix,2)
        <span class="comment">% &#21508;&#34892;&#21015;&#35201;&#32032;</span>
        <span class="comment">% disp(col+" "+row)</span>
        termlist = binearmatrix{col,row};
        <span class="comment">%</span>
        xidx = 0; <span class="comment">% &#21452;&#32218;&#24418;&#38917;&#12395;&#12362;&#12369;&#12427;Xstr&#12398;&#20301;&#32622;</span>
        yidx = 0; <span class="comment">% &#21452;&#32218;&#24418;&#38917;&#12395;&#12362;&#12369;&#12427;Ystr&#12398;&#20301;&#32622;</span>
<span class="comment">%         Llist = {}; % &#19968;&#26178;&#12522;&#12473;&#12488;</span>
<span class="comment">%         Nlist = {};</span>
<span class="comment">%         Rlist = {};</span>
        <span class="keyword">for</span> i=1:size(termlist,1)
            <span class="comment">% &#35201;&#32032;&#12398;&#21508;&#38917;</span>
            term = termlist{i,1};
            <span class="keyword">for</span> j=1:size(term,2)
                <span class="comment">% &#38917;&#12398;&#12381;&#12428;&#12382;&#12428;&#12398;&#22793;&#25968;</span>
                var = term{1,j};
                <span class="keyword">if</span> regexp(var, Xstr, <span class="string">'once'</span>)
                    xidx = j;
                <span class="keyword">elseif</span> regexp(var, Ystr, <span class="string">'once'</span>)
                    yidx = j;
                <span class="keyword">end</span>
            <span class="keyword">end</span>
            <span class="comment">% P,K(X,Y)&#12391;&#12522;&#12473;&#12488;&#12434;3&#20998;&#21106;&#12377;&#12427;</span>
            l = term(1:xidx-1);
            n = term(xidx+1:yidx-1);
            r = term(yidx+1:end);
            <span class="comment">% "PK"&#12398;&#22580;&#21512;&#65306; "1*P*1*K*1"&#12392;&#20966;&#29702;&#12377;&#12427;</span>
            <span class="keyword">if</span> isempty(l)
                l = {<span class="string">"1eye"</span>};
            <span class="keyword">elseif</span> l{1,1} == <span class="string">"-"</span>
                l = [<span class="string">"-"</span>, <span class="string">"1eye"</span>];
            <span class="keyword">end</span>
            <span class="keyword">if</span> isempty(n)
                n = {<span class="string">"1eye"</span>};
            <span class="keyword">elseif</span> n{1,1} == <span class="string">"-"</span>
                n = [<span class="string">"-"</span>, <span class="string">"1eye"</span>];
            <span class="keyword">end</span>
            <span class="keyword">if</span> isempty(r)
                r = {<span class="string">"1eye"</span>};
            <span class="keyword">elseif</span> r{1,1} == <span class="string">"-"</span>
                r = [<span class="string">"-"</span>, <span class="string">"1eye"</span>];
            <span class="keyword">end</span>

            <span class="comment">% L,N,R&#12398;&#26356;&#26032;</span>
            <span class="comment">% &#26410;&#23436;&#25104;(&#20206;)</span>
            <span class="comment">% &#21452;&#32218;&#24418;&#38917;&#12364;1&#34892;&#30446;&#12395;&#12354;&#12427;&#22580;&#21512;&#12395;&#12375;&#12363;&#23550;&#24540;&#12391;&#12365;&#12394;&#12356;</span>
            <span class="keyword">if</span> col == 1
                <span class="keyword">if</span> isempty(L)
                    L = updateList(L,l);
                <span class="keyword">end</span>
                N = {n};
                R = updateList(R,r,1);
            <span class="keyword">end</span>
        <span class="keyword">end</span>

        <span class="comment">% &#26410;&#23436;&#25104;(&#20206;)</span>
        <span class="keyword">if</span> col == 1 &amp;&amp; isempty(termlist)
            R = updateList(R,{<span class="string">"0zero"</span>},1);
        <span class="keyword">end</span>

<span class="comment">%         L = updateList(L,Llist);</span>
<span class="comment">%         N = updateList(N,Nlist);</span>
<span class="comment">%         R = updateList(R,Rlist);</span>
    <span class="keyword">end</span>

    <span class="comment">% &#26410;&#23436;&#25104;(&#20206;)</span>
    <span class="keyword">if</span> col &gt;= 2
        L = updateList(L,{<span class="string">"0zero"</span>},1);
    <span class="keyword">end</span>
<span class="keyword">end</span>
<span class="comment">% &#12487;&#12496;&#12483;&#12464;&#29992;:</span>
<span class="comment">% L{1,1}</span>
<span class="comment">% isempty(L{1,1})</span>
<span class="comment">% Q,Q{3,1}{2,1}</span>
<span class="comment">% L,N,R</span>
</pre><h2 id="9">&#36880;&#27425;LMI&#12395;&#22793;&#24418;&#12375;&#12390;Calc</h2><p>evalin&#12434;&#20351;&#12358;&#65292;workspace&#12398;&#22793;&#25968;&#12398;&#20516;&#12398;&#21462;&#24471; &#20351;&#29992;&#20363;:   evalin('base','X'): workspace&#12398;&#22793;&#25968;&#21517;X&#12398;&#20516;&#12434;&#21462;&#24471;&#12377;&#12427;   evalin('base','eye(p1)'): workspace&#12398;&#22793;&#25968;&#12398;&#20516;&#12434;&#20351;&#12387;&#12390;&#38306;&#25968;eye(p1)&#12434;&#23455;&#34892;&#12377;&#12427;</p><pre class="codeinput"><span class="comment">% &#27770;&#23450;&#22793;&#25968;&#12398;&#21462;&#24471;</span>
X = evalin(<span class="string">'base'</span>, Xstr);
Y = evalin(<span class="string">'base'</span>, Ystr);
<span class="comment">% &#26283;&#23450;&#35299;&#12398;&#21462;&#24471;</span>
X0 = evalin(<span class="string">'base'</span>, X0str);
Y0 = evalin(<span class="string">'base'</span>, Y0str);


<span class="comment">% &#12502;&#12525;&#12483;&#12463;&#34892;&#21015;&#12398;&#12469;&#12452;&#12474;&#12398;&#35336;&#31639;</span>
<span class="comment">% &#21046;&#32004;&#34892;&#21015;&#12398;&#23550;&#35282;&#12502;&#12525;&#12483;&#12463;&#12363;&#12425;&#21106;&#12426;&#20986;&#12377;</span>
colsize = []; <span class="comment">% &#21508;&#12502;&#12525;&#12483;&#12463;&#12398;&#34892;&#12469;&#12452;&#12474;</span>
rowsize = []; <span class="comment">% &#21508;&#12502;&#12525;&#12483;&#12463;&#12398;&#21015;&#12469;&#12452;&#12474;</span>
<span class="keyword">for</span> i=1:size(orgmatrix,1)
    idx = 1;
    s = orgmatrix{i,i}{1,1}{1,1};
    <span class="keyword">for</span> j=1:size(orgmatrix,1)
        <span class="keyword">if</span> s == <span class="string">"-"</span>
            idx = idx+1;
            <span class="keyword">break</span>
        <span class="keyword">end</span>
    <span class="keyword">end</span>
    s = orgmatrix{i,i}{1,1}{1,idx}; <span class="comment">% &#38917;&#12398;&#19968;&#30058;&#24038;&#12398;&#22793;&#25968;</span>
    e = orgmatrix{i,i}{1,1}{1,end}; <span class="comment">% &#38917;&#12398;&#19968;&#30058;&#21491;&#12398;&#22793;&#25968;</span>
    ssize = size(evalin(<span class="string">'base'</span>,s),1);
    esize = size(evalin(<span class="string">'base'</span>,e),2);
    colsize = cat(2,colsize,ssize);
    rowsize = cat(2,rowsize,esize);
<span class="keyword">end</span>
<span class="comment">% colsize,rowsize</span>


<span class="comment">% &#32218;&#24418;&#38917;&#12398;&#35336;&#31639;</span>
Qeval = [];
<span class="keyword">for</span> col=1:size(Q,1)
    <span class="comment">% &#21508;&#34892;&#12505;&#12463;&#12488;&#12523;</span>
    Qcol = [];
    <span class="keyword">for</span> row=1:size(Q,2)
        <span class="comment">% &#21508;&#34892;&#21015;&#35201;&#32032;</span>
        <span class="comment">% disp(col+" "+row)</span>
        termlist = Q{col,row};
        <span class="comment">%</span>
        Qevalelem = 0;
        <span class="keyword">for</span> i=1:size(termlist,1)
            term = termlist{i,1};
            qeval = 1;
            <span class="keyword">for</span> j=1:size(term,2)
                var = term{1,j};
                <span class="keyword">if</span> var == <span class="string">"-"</span>
                    qeval = -qeval;
                <span class="keyword">else</span>
<span class="comment">%                     if regexp(var,'(?&lt;!\D+)\d+')</span>
<span class="comment">%                         % &#25968;&#20516;&#12398;&#22580;&#21512;</span>
<span class="comment">%                         qeval = qeval * str2double(var);</span>
<span class="comment">%                     else</span>
<span class="comment">%                         % &#22793;&#25968;&#21517;&#12398;&#22580;&#21512;</span>
<span class="comment">%                         qeval = qeval * evalin('base', var);</span>
<span class="comment">%                     end</span>
                    qeval = qeval * evalin(<span class="string">'base'</span>, var);
                <span class="keyword">end</span>
            <span class="keyword">end</span>
            Qevalelem = Qevalelem + qeval;
        <span class="keyword">end</span>

        <span class="comment">% &#35201;&#32032;&#12395;&#38917;&#12364;&#12394;&#12356;&#22580;&#21512;&#65292;&#12476;&#12525;&#34892;&#21015;&#12434;&#20837;&#12428;&#12427;</span>
        <span class="keyword">if</span> isempty(termlist)
            <span class="comment">% col,row</span>
            z = zeros(colsize(col),rowsize(row));
            Qcol = cat(2,Qcol,z);
        <span class="keyword">else</span>
            <span class="comment">% &#23550;&#35282;&#35201;&#32032;&#12399;1/2&#20493;</span>
            <span class="keyword">if</span> col == row &amp;&amp; col &gt;= 2
                <span class="comment">% (1,1)&#35201;&#32032;&#12395;&#23550;&#12375;&#12390;&#12418;&#23455;&#34892;&#12377;&#12427;&#24517;&#35201;&#12364;&#12354;&#12427;</span>
                <span class="comment">% &#26410;&#23455;&#35013;</span>
                Qevalelem = Qevalelem / 2;
            <span class="keyword">end</span>
            Qcol = cat(2,Qcol,Qevalelem);
        <span class="keyword">end</span>
        <span class="comment">% Qcol</span>

    <span class="keyword">end</span>
    Qeval = cat(1,Qeval,Qcol);
<span class="keyword">end</span>
<span class="comment">% Qeval</span>


<span class="comment">% &#21452;&#32218;&#24418;&#38917;&#12398;&#24038;&#23450;&#25968;L&#12398;&#35336;&#31639;</span>
Leval = [];
<span class="keyword">for</span> i=1:size(L,1)
    term = L{i,1};
    leval = 1;
    <span class="keyword">for</span> j=1:size(term,2)
        var = term{1,j};
        <span class="keyword">if</span> var == <span class="string">"1eye"</span>
            leval = leval * eye(size(X,1));
        <span class="keyword">elseif</span> var == <span class="string">"0zero"</span>
            leval = leval * zeros(rowsize(i),size(Leval,2));
        <span class="keyword">elseif</span> var == <span class="string">"-"</span>
            leval = -leval;
        <span class="keyword">else</span>
<span class="comment">%             if regexp(var,'(?&lt;!\D+)\d+')</span>
<span class="comment">%                 leval = leval * str2double(var);</span>
<span class="comment">%             else</span>
<span class="comment">%                 leval = leval * evalin('base', var);</span>
<span class="comment">%             end</span>
            leval = leval * evalin(<span class="string">'base'</span>, var);
        <span class="keyword">end</span>
    <span class="keyword">end</span>
    <span class="comment">% &#21015;(&#32294;)&#12505;&#12463;&#12488;&#12523;&#12434;&#29983;&#25104;</span>
    Leval = cat(1,Leval,leval);
<span class="keyword">end</span>
<span class="comment">% Leval</span>


<span class="comment">% &#21452;&#32218;&#24418;&#38917;&#12398;&#20013;&#23450;&#25968;N&#12398;&#35336;&#31639;</span>
Neval = [];
<span class="keyword">for</span> i=1:size(N,1)
    term = N{i,1};
    neval = 1;
    <span class="keyword">for</span> j=1:size(term,2)
        var = term{1,j};
        <span class="keyword">if</span> var == <span class="string">"1eye"</span>
            neval = neval * eye(size(X,2),size(Y,1));
        <span class="keyword">elseif</span> var == <span class="string">"-"</span>
            neval = -neval;
        <span class="keyword">else</span>
<span class="comment">%             if regexp(var,'(?&lt;!\D+)\d+')</span>
<span class="comment">%                 neval = neval * str2double(var);</span>
<span class="comment">%             else</span>
<span class="comment">%                 neval = neval * evalin('base', var);</span>
<span class="comment">%             end</span>
            neval = neval * evalin(<span class="string">'base'</span>, var);
        <span class="keyword">end</span>
    <span class="keyword">end</span>
    Neval = neval;
<span class="keyword">end</span>
<span class="comment">% Neval</span>


<span class="comment">% &#21452;&#32218;&#24418;&#38917;&#12398;&#21491;&#23450;&#25968;R&#12398;&#35336;&#31639;</span>
Reval = [];
<span class="keyword">for</span> i=1:size(R,1)
    term = R{i,1};
    reval = 1;
    <span class="keyword">for</span> j=1:size(term,2)
        var = term{1,j};
        <span class="keyword">if</span> var == <span class="string">"1eye"</span>
            reval = reval * eye(size(Y,2));
        <span class="keyword">elseif</span> var == <span class="string">"0zero"</span>
            reval = reval * zeros(size(Reval,1),rowsize(i));
        <span class="keyword">elseif</span> var == <span class="string">"-"</span>
            reval = -reval;
        <span class="keyword">else</span>
<span class="comment">%             if regexp(var,'(?&lt;!\D+)\d+')</span>
<span class="comment">%                 reval = reval * str2double(var);</span>
<span class="comment">%             else</span>
<span class="comment">%                 reval = reval * evalin('base', var);</span>
<span class="comment">%             end</span>
            reval = reval * evalin(<span class="string">'base'</span>, var);
        <span class="keyword">end</span>
    <span class="keyword">end</span>
    <span class="comment">% &#34892;(&#27178;)&#12505;&#12463;&#12488;&#12523;&#12434;&#29983;&#25104;</span>
    Reval = cat(2,Reval,reval);
<span class="keyword">end</span>
<span class="comment">% Reval</span>


<span class="comment">% &#21452;&#32218;&#24418;&#38917;&#12398;&#35336;&#31639;, LXNYR</span>
Bieval = Leval * X * Neval * Y * Reval;

<span class="comment">% BMI&#12398;&#20516;&#12398;&#35336;&#31639;, &#22810;&#20998;&#20351;&#12431;&#12394;&#12356;&#65292;&#12487;&#12496;&#12483;&#12464;&#29992;</span>
BMIeval = Qeval + Bieval;


<span class="keyword">if</span> nargin&lt;4
    G=eye(size(Y,1));
<span class="keyword">elseif</span> isa(G,<span class="string">'string'</span>) || isa(G,<span class="string">'char'</span>)
    G=evalin(<span class="string">'base'</span>,G);
<span class="keyword">end</span>

<span class="comment">% &#25313;&#22823;&#12375;&#12383; LMI &#26465;&#20214;, he&#12394;&#12375;</span>
LMIeval=[Qeval+replace(Bieval,Y,Y0)+replace(Bieval,X,X0)-Leval*X0*Neval*Y0*Reval,<span class="keyword">...</span>
         Leval*(X-X0)*Neval;<span class="keyword">...</span>
         G*(Y-Y0)*Reval,<span class="keyword">...</span>
         -G];
<span class="comment">% he&#12354;&#12426;</span>
<span class="comment">% LMIeval = [Qeval+Leval*X*Neval*Y0*Reval+Leval*X0*Neval*Y*Reval-Leval*X0*Neval*Y0*Reval+...</span>
<span class="comment">%         (Qeval+Leval*X*Neval*Y0*Reval+Leval*X0*Neval*Y*Reval-Leval*X0*Neval*Y0*Reval)',...</span>
<span class="comment">%          Leval*(X-X0)*Neval+Reval'*(Y-Y0)'*G';...</span>
<span class="comment">%         (Leval*(X-X0)*Neval+Reval'*(Y-Y0)'*G')',...</span>
<span class="comment">%          -2*G];</span>
</pre><h2 id="10">&#12487;&#12496;&#12483;&#12464;&#29992;&#20986;&#21147;, &#19968;&#33324;&#21270;BMI&#12398;&#24773;&#22577;</h2><pre class="codeinput"><span class="comment">%%%% he&#12394;&#12375;</span>
<span class="comment">% Q0= Qeval; % &#32218;&#24418;&#38917;</span>
<span class="comment">% L = Leval; % &#21452;&#32218;&#24418;&#38917;&#12398;&#23450;&#25968;&#34892;&#21015;(&#24038;)</span>
<span class="comment">% N = Neval; % &#21452;&#32218;&#24418;&#38917;&#12398;&#23450;&#25968;&#34892;&#21015;(&#20013;)</span>
<span class="comment">% R = Reval; % &#21452;&#32218;&#24418;&#38917;&#12398;&#23450;&#25968;&#34892;&#21015;(&#21491;)</span>

gBMI.expression = <span class="string">'Q+He(LXNYR)'</span>;
gBMI.sdpvar = {Xstr,Ystr};
gBMI.Q = Qeval;
gBMI.L = Leval;
gBMI.N = Neval;
gBMI.R = Reval;
</pre><h2 id="11">&#38306;&#25968;&#12398;&#20986;&#21147;</h2><pre class="codeinput">LMI = LMIeval + LMIeval';
BMI = BMIeval + BMIeval';
</pre><pre class="codeinput"><span class="keyword">end</span>
</pre><h2 id="13">&#20869;&#37096;&#38306;&#25968;&#32676;</h2><h2 id="14">List&#12398;&#26356;&#26032;&#65288;&#36861;&#21152;&#65289;&#12392;&#21021;&#26399;&#21270;</h2><pre class="codeinput"><span class="keyword">function</span> [L,V] = updateList(L,V,n)
    <span class="comment">% ex)</span>
    <span class="comment">%   L&#12395;V&#12434;&#36861;&#21152;&#65292;V&#12434;&#21021;&#26399;&#21270;:</span>
    <span class="comment">%     [L,V] = updateList(L,V)</span>
    <span class="comment">%   L&#12395;V&#12434;&#36861;&#21152;&#12398;&#12415;:</span>
    <span class="comment">%     L = updateList(L,V)</span>

    <span class="keyword">if</span> nargin&lt;3
        n = 2;
    <span class="keyword">end</span>

    <span class="comment">% List&#12398;&#36861;&#21152;</span>
    <span class="comment">% n=1: &#32294;&#12395;&#36861;&#21152;</span>
    <span class="comment">% n=2: &#27178;&#12395;&#36861;&#21152;</span>
    L = cat(n,L,{V});

    <span class="keyword">if</span> isa(V, <span class="string">"string"</span>)
        <span class="comment">% string&#12398;&#21021;&#26399;&#21270;</span>
        V = <span class="string">""</span>;
    <span class="keyword">elseif</span> isa(V, <span class="string">"cell"</span>)
        <span class="comment">% cell&#12398;&#21021;&#26399;&#21270;</span>
        V = {};
    <span class="keyword">end</span>
<span class="keyword">end</span>
</pre><h2 id="15">&#25324;&#24359;()&#12434;&#23637;&#38283;&#12377;&#12427;&#38306;&#25968;</h2><pre class="codeinput"><span class="keyword">function</span> S = divbracket(S)
</pre><pre class="codeinput">    <span class="comment">% &#23550;&#24540;&#12377;&#12427;&#27491;&#35215;&#34920;&#29694;</span>
    <span class="comment">% TODO:</span>
    <span class="comment">%   &#12502;&#12525;&#12483;&#12463;&#34892;&#21015;&#12434;&#25324;&#24359;&#12391;&#22258;&#12435;&#12384;&#34920;&#29694; ([...])'&#12434;&#12393;&#12358;&#20966;&#29702;&#12377;&#12427;&#12363;</span>
</pre><h2 id="17">&#27491;&#35215;&#34920;&#29694;&#29992;&#12510;&#12472;&#12483;&#12463;&#12490;&#12531;&#12496;&#12540;&#65292;&#27491;&#35215;&#34920;&#29694;&#12434;&#35201;&#32032;&#12372;&#12392;&#12395;&#20998;&#35299;</h2><p>&#22793;&#25968;&#21517;&#65292;&#36578;&#32622;&#20184;&#12365; ex) A, B1'</p><pre class="codeinput">    VAR = <span class="string">"\w+(\')*"</span>;

    <span class="comment">% &#38306;&#25968;</span>
    <span class="comment">% ex) eye(n,n)</span>
    FUNC = <span class="string">"\w+\([\w\,\']+\)(\')*"</span>;

    <span class="comment">% &#38306;&#25968;&#12418;&#12375;&#12367;&#12399;&#22793;&#25968;&#21517;, &#20516;&#12434;&#25345;&#12388;&#12488;&#12540;&#12463;&#12531;</span>
    <span class="comment">% ex) eye(n), A'</span>
    FUNC_OR_VAR = <span class="string">"("</span>+FUNC+<span class="string">"|"</span>+VAR+<span class="string">")"</span>;

    <span class="comment">% &#24335;&#12398;&#38917;</span>
    <span class="comment">% ex) A, A*B1, eye(n)*A'</span>
    TERM = FUNC_OR_VAR+<span class="string">"(\*"</span>+FUNC_OR_VAR+<span class="string">")*"</span>;

    <span class="comment">% &#24335;</span>
    <span class="comment">% ex) A+B1'*eye(n)</span>
    EXP = FUNC_OR_VAR+<span class="string">"((+|*)"</span>+FUNC_OR_VAR+<span class="string">")*"</span>;


    <span class="comment">% &#25324;&#24359;&#12398;&#21069;&#24460;&#12395;&#31309;&#12364;&#12394;&#12356; &amp; &#38306;&#25968;&#12398;&#25324;&#24359;&#12391;&#12394;&#12356;</span>
    <span class="comment">% ex) (A+B*C)</span>
    <span class="comment">% eye(n)&#12392;&#12399;&#12510;&#12483;&#12481;&#12531;&#12464;&#12375;&#12394;&#12356;</span>
    BRACKET_EXP = <span class="string">"(?&lt;!\w+)"</span>+<span class="string">"\("</span>+EXP+<span class="string">"\)"</span>;

    <span class="comment">% &#25324;&#24359;&#12398;&#36578;&#32622;</span>
    <span class="comment">% ex) (A+B*C)'</span>
    BRACKET_TRANSPOSE = BRACKET_EXP+<span class="string">"\'"</span>;

    <span class="comment">% &#25324;&#24359;&#12392;&#25324;&#24359;&#12398;&#31309;</span>
    <span class="comment">% ex) (A+B*C)*(A+B*C)</span>
    <span class="comment">% eye(n)*(A+B*C) &#12392;&#12399;&#12510;&#12483;&#12481;&#12531;&#12464;&#12375;&#12394;&#12356;</span>
    PROD_BRACKET = <span class="string">"(\*"</span>+BRACKET_EXP+<span class="string">")+"</span>+<span class="string">"(?!.*\))"</span>;
    BRACKET_PROD_BRACKET = BRACKET_EXP + PROD_BRACKET;

    <span class="comment">% &#25324;&#24359;&#12398;&#21069;&#12395;&#31309;</span>
    <span class="comment">% ex) D*(A+B*C)</span>
    LEFT_PROD = <span class="string">"("</span>+FUNC_OR_VAR+<span class="string">"\*)+"</span>;
    LEFT_PROD_BRACKET = LEFT_PROD + BRACKET_EXP;

    <span class="comment">% &#25324;&#24359;&#12398;&#24460;&#12395;&#31309;</span>
    <span class="comment">% ex) (A+B*C)*D</span>
    <span class="comment">% eye(n)*D &#12392;&#12399;&#12510;&#12483;&#12481;&#12531;&#12464;&#12375;&#12394;&#12356;</span>
    PROD_RIGHT = <span class="string">"(\*"</span>+FUNC_OR_VAR+<span class="string">")+"</span>+<span class="string">"(?!.*\))"</span>;
    BRACKET_PROD_RIGHT = BRACKET_EXP + PROD_RIGHT;
</pre><h2 id="18">&#21508;&#12497;&#12479;&#12540;&#12531;&#12395;&#12362;&#12369;&#12427;&#25324;&#24359;()&#12398;&#20966;&#29702;</h2><p>&#25324;&#24359;&#12398;&#36578;&#32622;&#65292;&#25324;&#24359;&#20869;&#12398;&#31309;&#12398;&#38918;&#24207;&#12364;&#36870;&#36578;</p><pre class="codeinput">    <span class="keyword">if</span> regexp(S,BRACKET_TRANSPOSE)
        <span class="comment">% &#27491;&#35215;&#34920;&#29694;&#12395;&#23550;&#24540;&#12377;&#12427;&#25991;&#23383;&#21015;</span>
        bracket = regexp(S,BRACKET_TRANSPOSE,<span class="string">'match'</span>,<span class="string">'once'</span>);
        <span class="comment">% &#25324;&#24359;&#12398;&#20013;&#12398;&#24335;</span>
        bracketin = regexp(bracket,EXP,<span class="string">'match'</span>,<span class="string">'once'</span>);
        <span class="comment">%</span>
        <span class="comment">% &#25324;&#24359;&#12398;&#20013;&#12398;&#21508;&#38917;</span>
        term = regexp(bracketin,TERM,<span class="string">'match'</span>);
        <span class="comment">% &#25324;&#24359;&#12398;&#20013;&#12398;&#25991;&#23383;&#21015;(&#26368;&#32066;&#30340;&#12395;&#27714;&#12417;&#12383;&#12356;&#12418;&#12398;)</span>
        bracketstr = <span class="string">""</span>;
        <span class="keyword">for</span> i=1:length(term)
            <span class="comment">% &#21508;&#38917;&#12398;&#25991;&#23383;&#21015;</span>
            termstr = <span class="string">""</span>;
            <span class="comment">% &#21508;&#38917;&#12398;&#22793;&#25968;&#12398;cell&#37197;&#21015;</span>
            var = regexp(term{1,i},FUNC_OR_VAR,<span class="string">'match'</span>);
            <span class="keyword">for</span> j=1:length(var)
                <span class="comment">% &#37197;&#21015;&#12434;&#36870;&#12363;&#12425;&#20966;&#29702;&#65292;&#36578;&#32622;'&#12434;&#21152;&#12360;&#12390;*&#12391;&#36899;&#32080;</span>
                <span class="keyword">if</span> j==1
                    termstr = termstr + string(var(end-j+1)) + <span class="string">"'"</span>;
                <span class="keyword">else</span>
                    termstr = termstr + <span class="string">"*"</span> + string(var(end-j+1)) + <span class="string">"'"</span>;
                <span class="keyword">end</span>
            <span class="keyword">end</span>

            <span class="comment">% &#19978;&#12391;&#20966;&#29702;&#12375;&#12383;&#21508;&#38917;&#12434;+&#12391;&#36899;&#32080;</span>
            <span class="keyword">if</span> i==1
                bracketstr = bracketstr + termstr;
            <span class="keyword">else</span>
                bracketstr = bracketstr + <span class="string">"+"</span> + termstr;
            <span class="keyword">end</span>
        <span class="keyword">end</span>
        <span class="comment">% &#25324;&#24359;()&#12391;&#22258;&#12415;&#32622;&#25563;&#12377;&#12427;</span>
        rep = <span class="string">"("</span> + bracketstr + <span class="string">")"</span>;
        S = regexprep(S,BRACKET_TRANSPOSE,rep,<span class="string">'once'</span>);


    <span class="comment">% &#25324;&#24359;&#12392;&#25324;&#24359;&#12398;&#31309;</span>
    <span class="keyword">elseif</span> regexp(S,BRACKET_PROD_BRACKET)
        <span class="comment">% &#27491;&#35215;&#34920;&#29694;&#12392;&#23550;&#24540;&#12377;&#12427;&#25991;&#23383;&#21015;</span>
        bracketterm = regexp(S,BRACKET_PROD_BRACKET,<span class="string">'match'</span>,<span class="string">'once'</span>);
        <span class="comment">% &#25324;&#24359;&#12392;&#12398;&#31309;</span>
        mult = regexp(bracketterm,PROD_BRACKET,<span class="string">'match'</span>,<span class="string">'once'</span>);
        <span class="comment">% &#25324;&#24359;&#12398;&#38917;</span>
        bracket = regexp(bracketterm,BRACKET_EXP,<span class="string">'match'</span>,<span class="string">'once'</span>);
        <span class="comment">% &#25324;&#24359;&#12398;&#20013;&#12398;&#24335;</span>
        bracketin = regexp(bracket,EXP,<span class="string">'match'</span>,<span class="string">'once'</span>);
        <span class="comment">% &#32622;&#12365;&#25563;&#12360;&#12427;&#25991;&#23383;&#21015;&#65292;&#25324;&#24359;&#12398;&#20013;&#12398;&#21508;&#38917;&#12392;&#12398;&#31309;</span>
        rep = regexprep(bracketin,TERM,<span class="string">"$0"</span>+mult);
        <span class="comment">% &#25324;&#24359;&#12434;&#23637;&#38283;&#12375;&#12383;&#24335;&#12395;&#22793;&#25563;&#12377;&#12427;</span>
        S = regexprep(S,BRACKET_PROD_BRACKET,rep,<span class="string">'once'</span>);


    <span class="comment">% &#25324;&#24359;&#12398;&#21069;&#12395;&#31309;</span>
    <span class="keyword">elseif</span> regexp(S,LEFT_PROD_BRACKET)
        <span class="comment">% &#27491;&#35215;&#34920;&#29694;&#12392;&#23550;&#24540;&#12377;&#12427;&#25991;&#23383;&#21015;</span>
        bracketterm = regexp(S,LEFT_PROD_BRACKET,<span class="string">'match'</span>,<span class="string">'once'</span>);
        <span class="comment">% &#25324;&#24359;&#12392;&#12398;&#31309;</span>
        mult = regexp(bracketterm,LEFT_PROD,<span class="string">'match'</span>,<span class="string">'once'</span>);
        <span class="comment">% &#25324;&#24359;&#12398;&#38917;</span>
        bracket = regexp(bracketterm,BRACKET_EXP,<span class="string">'match'</span>,<span class="string">'once'</span>);
        <span class="comment">% &#25324;&#24359;&#12398;&#20013;&#12398;&#24335;</span>
        bracketin = regexp(bracket,EXP,<span class="string">'match'</span>,<span class="string">'once'</span>);
        <span class="comment">% &#32622;&#12365;&#25563;&#12360;&#12427;&#25991;&#23383;&#21015;&#65292;&#25324;&#24359;&#12398;&#20013;&#12398;&#21508;&#38917;&#12392;&#12398;&#31309;</span>
        rep = regexprep(bracketin,TERM,mult+<span class="string">"$0"</span>);
        <span class="comment">% &#25324;&#24359;&#12434;&#23637;&#38283;&#12375;&#12383;&#24335;&#12395;&#22793;&#25563;&#12377;&#12427;</span>
        S = regexprep(S,LEFT_PROD_BRACKET,<span class="string">"("</span>+rep+<span class="string">")"</span>,<span class="string">'once'</span>);


    <span class="comment">% &#25324;&#24359;&#12398;&#24460;&#12395;&#31309;</span>
    <span class="keyword">elseif</span> regexp(S,BRACKET_PROD_RIGHT)
        bracketterm = regexp(S,BRACKET_PROD_RIGHT,<span class="string">'match'</span>,<span class="string">'once'</span>);
        mult = regexp(bracketterm,PROD_RIGHT,<span class="string">'match'</span>,<span class="string">'once'</span>);
        bracket = regexp(bracketterm,BRACKET_EXP,<span class="string">'match'</span>,<span class="string">'once'</span>);
        bracketin = regexp(bracket,EXP,<span class="string">'match'</span>,<span class="string">'once'</span>);
        rep = regexprep(bracketin,TERM,<span class="string">"$0"</span>+mult);
        S = regexprep(S,BRACKET_PROD_RIGHT,rep,<span class="string">'once'</span>);


    <span class="comment">% &#25324;&#24359;&#12398;&#21069;&#24460;&#12395;&#31309;&#12364;&#12394;&#12356;&#65292;&#25324;&#24359;&#12434;&#22806;&#12377;</span>
    <span class="keyword">elseif</span> regexp(S,BRACKET_EXP)
        bracketterm = regexp(S,BRACKET_EXP,<span class="string">'match'</span>,<span class="string">'once'</span>);
        bracket = regexp(bracketterm,BRACKET_EXP,<span class="string">'match'</span>,<span class="string">'once'</span>);
        rep = regexp(bracket,EXP,<span class="string">'match'</span>,<span class="string">'once'</span>);
        S = regexprep(S,BRACKET_EXP,rep,<span class="string">'once'</span>);
    <span class="keyword">end</span>
</pre><pre class="codeinput"><span class="keyword">end</span>
</pre><p class="footer"><br><a href="https://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2020a</a><br></p></div><!--
##### SOURCE BEGIN #####
function [LMI,BMI,gBMI] = bmiparser(S, vlist, v0list, G)
% BMIの文字列を受け取り，逐次LMIの値を返すパーサー
%   
%   OUTPUT:
%       LMI: 逐次LMI(変換後)の値
%       BMI: BMI(変換前)の値
%       gBMI: 一般化BMI(He(Q+LXNYR))の行列の情報(構造体)
%
%   INPUT:
%       S: BMIの文字列
%           ex) "P*A+P*B*K*C+A'*P'+C'*K'*B'*P'"
%       vlist: 決定変数の文字列
%           ex) {'P','K'}
%       v0list: 暫定解の文字列
%           ex) {'P0','K0'}
%       G: gammaの定数倍，デフォルトで単位行列
%
%
%   ※ワークスペースの変数の値を利用して計算するので，
%     bmiparser関数を呼び出す前に，
%     あらかじめに変数を宣言する必要がある．
%       ex) 
%           X = sdpvar(2,2)
%           Y = sdpvar(3,2)
%           A = rand(2,3)
%           X0= rand(2,2) 
%           Y0= rand(3,2)
%           LMI = bmiparser("X*A*Y+(X*A*Y)'",{'X','Y'},{'X0','Y0'})
%
%
%   現段階：
%       ・()を使った分配法則や転置が可能, ()の入れ子は対応できていない
%       ・数値を直接記述した場合のスカラー倍にまだ対応できていない, 変数名は可能
%       ・行列[]の和による記述が可能
%       ・[]の入れ子にまだ対応できていない
%

% 文字列を文字ベクトルに変換
if isa(S,'string')
    S = char(S);
end
% str2sym(S)

% 関数引数の取得
Xstr =vlist{1};
Ystr =vlist{2};
X0str=v0list{1};
Y0str=v0list{2};


%% 字句解析の前処理

% 空文字を削減
S = regexprep(S,'(\s+)',' ')

% 括弧の処理
% eye(2,2)のように，関数の括弧は処理しない
while regexp(S,'(?<!\w+)\((.*)\)')
    % 括弧()を展開する
    S = divbracket(S);
end
% S

% 転置'の処理
% 奇数個:1コ に変換
S = regexprep(S,"\'(\'\')*","\'");
% 偶数個:0コ に変換
S = regexprep(S,"(\'\')+","");
%
S

%% 字句解析
% ex) "P*A+P*B*K*C"
% =>  {{"P","B"},{"P","B","K","C"}}
% ex) "P'*A'"
% =>  {{"P'","A'"}}

termlist = {}; % 項のリスト
varlist = {};  % 変数定数の配列(一時的)
varstr = "";   % 1つの変数の文字列(一時的)

% 制約が行列の場合
columlist = {}; % 行のリスト，termlistをこの中に入れる
colnum = 1;     % 行数
rownum = 1;     % 列数

% 複数行列の和に対応
matrixlist = {}; % 行列[...]の字句解析結果(smatrix)を格納する, 最終的に1つのsmatrixにする

% デバッグ用:
% disp("==========")
% 入力文字列を1文字ずつ解析
for i=1:strlength(S)
    % デバッグ用:
    % disp("REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH-")
    % S(i),varstr,varlist,termlist

    
    % 変数の文字列の場合
    % ex) 'var' = 'v'+'a'+'r' 
    % 正規表現[a-zA-Z_0-9], (), '
    % ex) a0は変数だが，0aは変数でない -> どう処理する？
    if regexp(S(i), "[\w\(\,\)\']")
        % どこまでが変数名かを推定する
        % 変数名の更新
        varstr = varstr + S(i);
        if i == strlength(S) 
            % 終端文字の場合，varlistをtermlistに追加
            % "A]"とかだと別処理が必要，"[...]"の処理
            [varlist, varstr] = updateList(varlist,varstr);
            [termlist, varlist] = updateList(termlist,varlist,1);
            [columlist, termlist] = updateList(columlist,termlist);
            %
            % smatrixをmatrixlistに追加
            if colnum > 1 || rownum > 1
                % ブロック行列の場合
                smatrix = reshape(columlist,colnum,rownum).';
            else
                % そうでない場合
                smatrix = columlist;
            end
            [matrixlist,smatrix] = updateList(matrixlist,smatrix);
        end
        continue
    end
    
    % 演算子の場合
    % 和+
    if regexp(S(i), '\+') 
        % varstrをvarlistに追加, varstr初期化
        [varlist, varstr] = updateList(varlist,varstr);
        % varlistをtermlistに追加，varlist初期化
        [termlist, varlist] = updateList(termlist,varlist,1);
        continue
    end
    % 積*
    if regexp(S(i), '\*')    
        [varlist, varstr] = updateList(varlist,varstr);
        continue
    end
    
    % 差-
    % ex) "-A*B": {"-","A","B"}
    if regexp(S(i), '\-')
        % 前までの項をリスト追加(あれば)
        if varstr ~= ""
            [varlist, varstr] = updateList(varlist,varstr);
            [termlist, varlist] = updateList(termlist,varlist,1);
        end
        % 新しい項の1文字目に入れる
        varstr = varstr + S(i);
        [varlist, varstr] = updateList(varlist,varstr);
        continue
    end
    
    % シングルクオーテーションの場合
    % ex) A'*B'：行列の転置をする時に使う
    % 現状 \w と同じ処理
%     if regexp(S(i), "\'")
%         varstr = varstr + S(i);
%         if i == strlength(S) 
%             % 終端文字の場合，termstrをtermlistに追加
%             [varlist, varstr] = updateList(varlist,varstr);
%             [termlist, varlist] = updateList(termlist,varlist,1);
%             [columlist, termlist] = updateList(columlist,termlist);
%         end
%         continue
%     end
        
    % 空文字の場合
    % ex) '[A B]' : 行列の列を生成するときに使う
    if regexp(S(i), '\s')    
        if ~isempty(regexp(S(i-1), '\s', 'once')) ||...
           ~isempty(regexp(S(i), '[\*\+]', 'once'))   
            continue
        elseif regexp(S(i-1), "[\w\'\)]")
            [varlist, varstr] = updateList(varlist,varstr);
            [termlist, varlist] = updateList(termlist,varlist,1);
            [columlist, termlist] = updateList(columlist,termlist);
            % 列数の更新
            rownum = rownum + 1;
            continue
        end
    end
    % セミコロン;の場合
    % ex) '[A;B]' : 行列の行を生成するときに使う
    if regexp(S(i), ';')
        [varlist, varstr] = updateList(varlist,varstr);
        [termlist, varlist] = updateList(termlist,varlist,1);
        [columlist, termlist] = updateList(columlist,termlist);
        % 行数更新
        colnum = colnum + 1;
        rownum = 1;
        continue
    end
    
    % [の場合
    % 制約は行列
    if regexp(S(i), '\[')
        % disp("Helo")
        % 行列を解析するための初期化
        termlist = {}; % 項のリスト
        varlist = {};  % 変数定数の配列(一時的)
        varstr = "";   % 1つの変数の文字列(一時的)
        columlist = {}; % 行のリスト
        colnum = 1;     % 行数
        rownum = 1;     % 列数
        continue
    end
    % ]の場合
    % 行列おわり
    if regexp(S(i), '\]')
        % disp("bye")
        [varlist, varstr] = updateList(varlist,varstr);
        [termlist, varlist] = updateList(termlist,varlist,1);
        [columlist, termlist] = updateList(columlist,termlist);
        %
        % smatrixの生成
        % Sの最終形態(cellの行列), columlistを縦に並べたもの
        if colnum > 1 || rownum > 1
            % ブロック行列の場合
            smatrix = reshape(columlist,colnum,rownum).';
        else
            % そうでない場合
            smatrix = columlist;
        end
        % smatrixをmatrixlistに追加
        [matrixlist,smatrix] = updateList(matrixlist,smatrix);
        continue
    end
    
end
% デバッグ
% columlist
% columlist{1,5}{1,1}
% colnum, rownum
% smatrix = cat(2,cat(2,smatrix{1,1},smatrix{2,1}),smatrix{3,1});
% smatrix = reshape(smatrix,[colnum,rownum])

% smatrixの生成
% Sの最終形態(cellの行列), columlistを縦に並べたもの
% if colnum > 1 || rownum > 1
%     % ブロック行列の場合
%     smatrix = reshape(columlist,colnum,rownum).';
% else
%     % そうでない場合
%     smatrix = columlist;
% end
% cat(2,matrixlist,smatrix)
% cat(2,matrixlist,{smatrix})
% matrixlist
% matrixlist{1,1}
% matrixlist{1,1}{1,1}
% matrixlist{1,1}{1,1}{1,1}
% matrixlist{1,1}{1,1}{1,1}{1,1}



%% 行列(matrixlist)の結合
for i=1:length(matrixlist)
    mat = matrixlist{1,i};
    if i == 1
        smatrix = mat;
        continue
    end 
    % 各smatrixの項を結合する
    for col=1:size(mat,1)
        for row=1:size(mat,2)
            smatrix{col,row} = cat(1,smatrix{col,row},mat{col,row});
        end 
    end
end

% デバッグ用:
% smatrix
% smatrix{1,1}
% smatrix{1,1}{1,1}
% smatrix{1,1}{1,1}{1,1}
% smatrix{2,1}{1,2}
% smatrix{2,1}{1,2}{1,1}
% smatrix{2,1}{1,2}{1,2}
% smatrix{3,1}{1,3}{1,2}

% smatrix(1,2)
% smatrix{1,2}
% columlist{1,3}{2,1}
% smatrix{1,3}{2,1}



%% heの分離

orgmatrix = smatrix; % 転置なし行列
hematrix = smatrix;  % 転置あり行列

orgtermlist = {};    % 項のリスト(初期化)
hetermlist = {};     % 項の転置ありリスト(初期化)

for col=1:size(smatrix,1)
    % 各行ベクトル
    for row=1:size(smatrix,2)
        % 各行列要素
        % disp(col+" "+row)
        termlist = smatrix{col,row};
        for i=1:size(termlist,1)
            % 要素の各項
            term = termlist{i,1};
            for j=1:size(term,2)
                % 項のそれぞれの変数
                var = term{1,j};
                if regexp(var, "\'")
                    % var
                    % hetermlist: 転置あり
                    hetermlist = updateList(hetermlist,term,1);
                    break
                else
                    % termlist: 転置なし
                    % if col == row && col >= 2
                    %     % (2,2),(3,3)要素は1/2倍する
                    %     % スカラー倍を実装しないとできない
                    % end
                    orgtermlist = updateList(orgtermlist,term,1);
                    break
                end
            end
        end
        % 転置なし行列の更新
        orgmatrix(col,row) = {orgtermlist};
        orgtermlist = {};
        % 転置あり行列の更新
        hematrix(col,row) = {hetermlist};
        hetermlist = {};
    end
end
% 'があったら，hematrixに追加
% デバッグ用:
% orgmatrix
% hematrix


%% 双線形項の分離
% 行列
linearmatrix = orgmatrix; % 定数項，1次項
binearmatrix = orgmatrix; % 双線形項

% 一時的リスト
linearlist = {}; % 定数項，1次項
binearlist = {}; % 双線形項


for col=1:size(orgmatrix,1)
    % 各行ベクトル
    for row=1:size(orgmatrix,2)
        % 各行列要素
        % disp(col+" "+row)
        termlist = orgmatrix{col,row};
        for i=1:size(termlist,1)
            % 要素の各項
            term = termlist{i,1};
            %
            varcount = 0; % 決定変数の数
            for j=1:size(term,2)
                % 項のそれぞれの変数
                var = term{1,j};
                if ~isempty(regexp(var, Xstr, 'once')) ||...
                   ~isempty(regexp(var, Ystr, 'once'))
                    varcount = varcount + 1;
                end
                if varcount >= 2
                    binearlist = updateList(binearlist,term,1);
                    break
                elseif j == size(term,2)
                    linearlist = updateList(linearlist,term,1);
                    break
                end
            end
        end
        % 線形項の行列
        linearmatrix(col,row) = {linearlist};
        linearlist = {};
        % 双線形項の行列
        binearmatrix(col,row) = {binearlist};
        binearlist = {};
    end
end
% デバッグ用:
% linearmatrix
% binearmatrix

% binearmatrix{1,1}{1,1}
% binearmatrix{1,2}{1,1}


%% BMI一般化，Q,L,N,Rの取得
Q = linearmatrix; % 定数項，一次項
L = {}; % 双線形項の定数行列(左)
N = {}; % 双線形項の定数行列(中)
R = {}; % 双線形項の定数行列(右)


for col=1:size(binearmatrix,1)
    % 各行ベクトル
    for row=1:size(binearmatrix,2)
        % 各行列要素
        % disp(col+" "+row)
        termlist = binearmatrix{col,row};
        %
        xidx = 0; % 双線形項におけるXstrの位置
        yidx = 0; % 双線形項におけるYstrの位置
%         Llist = {}; % 一時リスト
%         Nlist = {}; 
%         Rlist = {}; 
        for i=1:size(termlist,1)
            % 要素の各項
            term = termlist{i,1};
            for j=1:size(term,2)
                % 項のそれぞれの変数
                var = term{1,j};
                if regexp(var, Xstr, 'once')
                    xidx = j;
                elseif regexp(var, Ystr, 'once') 
                    yidx = j;
                end
            end    
            % P,K(X,Y)でリストを3分割する
            l = term(1:xidx-1);
            n = term(xidx+1:yidx-1);
            r = term(yidx+1:end);
            % "PK"の場合： "1*P*1*K*1"と処理する
            if isempty(l) 
                l = {"1eye"};
            elseif l{1,1} == "-"
                l = ["-", "1eye"];
            end
            if isempty(n)
                n = {"1eye"};
            elseif n{1,1} == "-"
                n = ["-", "1eye"];
            end
            if isempty(r)
                r = {"1eye"};
            elseif r{1,1} == "-"
                r = ["-", "1eye"];
            end

            % L,N,Rの更新
            % 未完成(仮)
            % 双線形項が1行目にある場合にしか対応できない
            if col == 1                
                if isempty(L)
                    L = updateList(L,l);
                end
                N = {n};
                R = updateList(R,r,1);
            end
        end
        
        % 未完成(仮)
        if col == 1 && isempty(termlist)
            R = updateList(R,{"0zero"},1);
        end
        
%         L = updateList(L,Llist);
%         N = updateList(N,Nlist);
%         R = updateList(R,Rlist);
    end
    
    % 未完成(仮)
    if col >= 2
        L = updateList(L,{"0zero"},1);
    end
end
% デバッグ用:
% L{1,1}
% isempty(L{1,1})
% Q,Q{3,1}{2,1}
% L,N,R


%% 逐次LMIに変形してCalc
% evalinを使う，workspaceの変数の値の取得
% 使用例:
%   evalin('base','X'): workspaceの変数名Xの値を取得する
%   evalin('base','eye(p1)'): workspaceの変数の値を使って関数eye(p1)を実行する



% 決定変数の取得
X = evalin('base', Xstr);
Y = evalin('base', Ystr);
% 暫定解の取得
X0 = evalin('base', X0str);
Y0 = evalin('base', Y0str);


% ブロック行列のサイズの計算
% 制約行列の対角ブロックから割り出す
colsize = []; % 各ブロックの行サイズ
rowsize = []; % 各ブロックの列サイズ
for i=1:size(orgmatrix,1)
    idx = 1;
    s = orgmatrix{i,i}{1,1}{1,1};
    for j=1:size(orgmatrix,1)
        if s == "-"
            idx = idx+1;
            break
        end
    end
    s = orgmatrix{i,i}{1,1}{1,idx}; % 項の一番左の変数
    e = orgmatrix{i,i}{1,1}{1,end}; % 項の一番右の変数
    ssize = size(evalin('base',s),1);
    esize = size(evalin('base',e),2);
    colsize = cat(2,colsize,ssize);
    rowsize = cat(2,rowsize,esize);
end
% colsize,rowsize


% 線形項の計算
Qeval = [];
for col=1:size(Q,1)
    % 各行ベクトル
    Qcol = [];
    for row=1:size(Q,2)
        % 各行列要素
        % disp(col+" "+row)
        termlist = Q{col,row};
        %
        Qevalelem = 0;
        for i=1:size(termlist,1)
            term = termlist{i,1};
            qeval = 1;
            for j=1:size(term,2)
                var = term{1,j};
                if var == "-"
                    qeval = -qeval;
                else
%                     if regexp(var,'(?<!\D+)\d+')
%                         % 数値の場合
%                         qeval = qeval * str2double(var);
%                     else
%                         % 変数名の場合
%                         qeval = qeval * evalin('base', var);
%                     end
                    qeval = qeval * evalin('base', var);
                end
            end
            Qevalelem = Qevalelem + qeval;
        end
        
        % 要素に項がない場合，ゼロ行列を入れる
        if isempty(termlist)
            % col,row
            z = zeros(colsize(col),rowsize(row));
            Qcol = cat(2,Qcol,z);
        else
            % 対角要素は1/2倍
            if col == row && col >= 2
                % (1,1)要素に対しても実行する必要がある
                % 未実装
                Qevalelem = Qevalelem / 2;
            end
            Qcol = cat(2,Qcol,Qevalelem);
        end
        % Qcol
        
    end
    Qeval = cat(1,Qeval,Qcol);
end
% Qeval


% 双線形項の左定数Lの計算
Leval = [];
for i=1:size(L,1)
    term = L{i,1};
    leval = 1; 
    for j=1:size(term,2)
        var = term{1,j};
        if var == "1eye"
            leval = leval * eye(size(X,1));
        elseif var == "0zero"
            leval = leval * zeros(rowsize(i),size(Leval,2));
        elseif var == "-"
            leval = -leval;
        else 
%             if regexp(var,'(?<!\D+)\d+')
%                 leval = leval * str2double(var);
%             else
%                 leval = leval * evalin('base', var);
%             end
            leval = leval * evalin('base', var);
        end
    end
    % 列(縦)ベクトルを生成
    Leval = cat(1,Leval,leval);
end
% Leval


% 双線形項の中定数Nの計算
Neval = [];
for i=1:size(N,1)
    term = N{i,1};
    neval = 1; 
    for j=1:size(term,2)
        var = term{1,j};
        if var == "1eye"
            neval = neval * eye(size(X,2),size(Y,1));
        elseif var == "-"
            neval = -neval;
        else
%             if regexp(var,'(?<!\D+)\d+')
%                 neval = neval * str2double(var);
%             else
%                 neval = neval * evalin('base', var);
%             end   
            neval = neval * evalin('base', var);
        end
    end
    Neval = neval;
end
% Neval


% 双線形項の右定数Rの計算
Reval = [];
for i=1:size(R,1)
    term = R{i,1};
    reval = 1; 
    for j=1:size(term,2)
        var = term{1,j};
        if var == "1eye"
            reval = reval * eye(size(Y,2));
        elseif var == "0zero"
            reval = reval * zeros(size(Reval,1),rowsize(i));
        elseif var == "-"
            reval = -reval;
        else
%             if regexp(var,'(?<!\D+)\d+')
%                 reval = reval * str2double(var);
%             else
%                 reval = reval * evalin('base', var);
%             end     
            reval = reval * evalin('base', var);
        end
    end
    % 行(横)ベクトルを生成
    Reval = cat(2,Reval,reval);
end
% Reval


% 双線形項の計算, LXNYR
Bieval = Leval * X * Neval * Y * Reval;

% BMIの値の計算, 多分使わない，デバッグ用
BMIeval = Qeval + Bieval;


if nargin<4
    G=eye(size(Y,1));
elseif isa(G,'string') || isa(G,'char') 
    G=evalin('base',G);
end

% 拡大した LMI 条件, heなし
LMIeval=[Qeval+replace(Bieval,Y,Y0)+replace(Bieval,X,X0)-Leval*X0*Neval*Y0*Reval,...
         Leval*(X-X0)*Neval;...
         G*(Y-Y0)*Reval,...
         -G];
% heあり
% LMIeval = [Qeval+Leval*X*Neval*Y0*Reval+Leval*X0*Neval*Y*Reval-Leval*X0*Neval*Y0*Reval+...
%         (Qeval+Leval*X*Neval*Y0*Reval+Leval*X0*Neval*Y*Reval-Leval*X0*Neval*Y0*Reval)',...
%          Leval*(X-X0)*Neval+Reval'*(Y-Y0)'*G';...
%         (Leval*(X-X0)*Neval+Reval'*(Y-Y0)'*G')',...
%          -2*G];


     
%% デバッグ用出力, 一般化BMIの情報
%%%% heなし
% Q0= Qeval; % 線形項
% L = Leval; % 双線形項の定数行列(左)
% N = Neval; % 双線形項の定数行列(中)
% R = Reval; % 双線形項の定数行列(右)

gBMI.expression = 'Q+He(LXNYR)';
gBMI.sdpvar = {Xstr,Ystr};
gBMI.Q = Qeval;
gBMI.L = Leval;
gBMI.N = Neval;
gBMI.R = Reval;


%% 関数の出力
LMI = LMIeval + LMIeval';
BMI = BMIeval + BMIeval';



end



%% 内部関数群
%% Listの更新（追加）と初期化
function [L,V] = updateList(L,V,n)
    % ex) 
    %   LにVを追加，Vを初期化:
    %     [L,V] = updateList(L,V)
    %   LにVを追加のみ: 
    %     L = updateList(L,V)

    if nargin<3
        n = 2;
    end

    % Listの追加
    % n=1: 縦に追加
    % n=2: 横に追加
    L = cat(n,L,{V});
    
    if isa(V, "string")
        % stringの初期化
        V = "";
    elseif isa(V, "cell")
        % cellの初期化
        V = {};
    end
end


%% 括弧()を展開する関数
function S = divbracket(S)

    % 対応する正規表現
    % TODO:
    %   ブロック行列を括弧で囲んだ表現 ([...])'をどう処理するか
    
    %% 正規表現用マジックナンバー，正規表現を要素ごとに分解
    % 変数名，転置付き
    % ex) A, B1'
    VAR = "\w+(\')*";
    
    % 関数
    % ex) eye(n,n)
    FUNC = "\w+\([\w\,\']+\)(\')*";
    
    % 関数もしくは変数名, 値を持つトークン
    % ex) eye(n), A'
    FUNC_OR_VAR = "("+FUNC+"|"+VAR+")";
    
    % 式の項
    % ex) A, A*B1, eye(n)*A'
    TERM = FUNC_OR_VAR+"(\*"+FUNC_OR_VAR+")*";
    
    % 式
    % ex) A+B1'*eye(n)
    EXP = FUNC_OR_VAR+"((+|*)"+FUNC_OR_VAR+")*";
    
    
    % 括弧の前後に積がない & 関数の括弧でない
    % ex) (A+B*C)
    % eye(n)とはマッチングしない
    BRACKET_EXP = "(?<!\w+)"+"\("+EXP+"\)";
    
    % 括弧の転置
    % ex) (A+B*C)'
    BRACKET_TRANSPOSE = BRACKET_EXP+"\'";
    
    % 括弧と括弧の積
    % ex) (A+B*C)*(A+B*C)
    % eye(n)*(A+B*C) とはマッチングしない
    PROD_BRACKET = "(\*"+BRACKET_EXP+")+"+"(?!.*\))";
    BRACKET_PROD_BRACKET = BRACKET_EXP + PROD_BRACKET;
    
    % 括弧の前に積
    % ex) D*(A+B*C) 
    LEFT_PROD = "("+FUNC_OR_VAR+"\*)+";
    LEFT_PROD_BRACKET = LEFT_PROD + BRACKET_EXP;
    
    % 括弧の後に積
    % ex) (A+B*C)*D
    % eye(n)*D とはマッチングしない
    PROD_RIGHT = "(\*"+FUNC_OR_VAR+")+"+"(?!.*\))";
    BRACKET_PROD_RIGHT = BRACKET_EXP + PROD_RIGHT;
    
    
    %% 各パターンにおける括弧()の処理
    % 括弧の転置，括弧内の積の順序が逆転
    if regexp(S,BRACKET_TRANSPOSE)
        % 正規表現に対応する文字列
        bracket = regexp(S,BRACKET_TRANSPOSE,'match','once');
        % 括弧の中の式
        bracketin = regexp(bracket,EXP,'match','once');
        %
        % 括弧の中の各項
        term = regexp(bracketin,TERM,'match');
        % 括弧の中の文字列(最終的に求めたいもの)
        bracketstr = "";
        for i=1:length(term)
            % 各項の文字列
            termstr = "";
            % 各項の変数のcell配列
            var = regexp(term{1,i},FUNC_OR_VAR,'match');
            for j=1:length(var)
                % 配列を逆から処理，転置'を加えて*で連結
                if j==1
                    termstr = termstr + string(var(end-j+1)) + "'";
                else
                    termstr = termstr + "*" + string(var(end-j+1)) + "'";
                end
            end

            % 上で処理した各項を+で連結
            if i==1
                bracketstr = bracketstr + termstr;
            else
                bracketstr = bracketstr + "+" + termstr;
            end
        end
        % 括弧()で囲み置換する
        rep = "(" + bracketstr + ")";
        S = regexprep(S,BRACKET_TRANSPOSE,rep,'once');
    
    
    % 括弧と括弧の積
    elseif regexp(S,BRACKET_PROD_BRACKET)
        % 正規表現と対応する文字列
        bracketterm = regexp(S,BRACKET_PROD_BRACKET,'match','once');
        % 括弧との積
        mult = regexp(bracketterm,PROD_BRACKET,'match','once');
        % 括弧の項
        bracket = regexp(bracketterm,BRACKET_EXP,'match','once');
        % 括弧の中の式
        bracketin = regexp(bracket,EXP,'match','once');
        % 置き換える文字列，括弧の中の各項との積
        rep = regexprep(bracketin,TERM,"$0"+mult);
        % 括弧を展開した式に変換する
        S = regexprep(S,BRACKET_PROD_BRACKET,rep,'once');
        
        
    % 括弧の前に積
    elseif regexp(S,LEFT_PROD_BRACKET)
        % 正規表現と対応する文字列
        bracketterm = regexp(S,LEFT_PROD_BRACKET,'match','once');
        % 括弧との積
        mult = regexp(bracketterm,LEFT_PROD,'match','once');
        % 括弧の項
        bracket = regexp(bracketterm,BRACKET_EXP,'match','once');
        % 括弧の中の式
        bracketin = regexp(bracket,EXP,'match','once');
        % 置き換える文字列，括弧の中の各項との積
        rep = regexprep(bracketin,TERM,mult+"$0");
        % 括弧を展開した式に変換する
        S = regexprep(S,LEFT_PROD_BRACKET,"("+rep+")",'once');
        
        
    % 括弧の後に積
    elseif regexp(S,BRACKET_PROD_RIGHT)
        bracketterm = regexp(S,BRACKET_PROD_RIGHT,'match','once');
        mult = regexp(bracketterm,PROD_RIGHT,'match','once');
        bracket = regexp(bracketterm,BRACKET_EXP,'match','once');
        bracketin = regexp(bracket,EXP,'match','once');
        rep = regexprep(bracketin,TERM,"$0"+mult);
        S = regexprep(S,BRACKET_PROD_RIGHT,rep,'once');
    
        
    % 括弧の前後に積がない，括弧を外す
    elseif regexp(S,BRACKET_EXP)
        bracketterm = regexp(S,BRACKET_EXP,'match','once');
        bracket = regexp(bracketterm,BRACKET_EXP,'match','once');
        rep = regexp(bracket,EXP,'match','once');
        S = regexprep(S,BRACKET_EXP,rep,'once');
    end
    
end

##### SOURCE END #####
--></body></html>